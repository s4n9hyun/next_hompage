{"version":3,"file":"next-s3-upload.cjs.production.min.js","sources":["../src/utils/config.ts","../src/utils/client.ts","../src/utils/keys.ts","../src/pages/api/s3-upload.ts","../src/hooks/use-s3-upload.tsx","../src/components/file-input.tsx","../src/hooks/use-uploader.ts","../src/hooks/use-presigned-upload.ts","../src/utils/private-files.ts","../src/utils/image-data.ts","../src/hooks/use-upload-files.tsx"],"sourcesContent":["export type S3Config = {\n  accessKeyId?: string;\n  secretAccessKey?: string;\n  bucket?: string;\n  region?: string;\n  endpoint?: string;\n  forcePathStyle?: boolean;\n};\n\nexport function getConfig(s3Config?: S3Config) {\n  return {\n    accessKeyId: s3Config?.accessKeyId ?? `${process.env.S3_UPLOAD_KEY}`,\n    secretAccessKey:\n      s3Config?.secretAccessKey ?? `${process.env.S3_UPLOAD_SECRET}`,\n    bucket: s3Config?.bucket ?? `${process.env.S3_UPLOAD_BUCKET}`,\n    region: s3Config?.region ?? `${process.env.S3_UPLOAD_REGION}`,\n    endpoint: s3Config?.endpoint,\n    forcePathStyle: s3Config?.forcePathStyle,\n  };\n}\n","import { S3Client } from '@aws-sdk/client-s3';\nimport { getConfig, S3Config } from './config';\n\nexport function getClient(s3Config?: S3Config) {\n  let config = getConfig(s3Config);\n\n  let client = new S3Client({\n    credentials: {\n      accessKeyId: config.accessKeyId,\n      secretAccessKey: config.secretAccessKey,\n    },\n    region: config.region,\n    ...(config.forcePathStyle ? { forcePathStyle: config.forcePathStyle } : {}),\n    ...(config.endpoint ? { endpoint: config.endpoint } : {}),\n  });\n\n  return client;\n}\n","import { v4 as uuidv4 } from 'uuid';\n\nexport const uuid = () => uuidv4();\n\nconst SAFE_CHARACTERS = /[^0-9a-zA-Z!_\\\\.\\\\*'\\\\(\\\\)\\\\\\-/]/g;\nexport const sanitizeKey = (value: string) =>\n  value.replace(SAFE_CHARACTERS, ' ').replace(/\\s+/g, '-');\n","import { NextApiRequest, NextApiResponse } from 'next';\nimport {\n  STSClient,\n  GetFederationTokenCommand,\n  STSClientConfig,\n} from '@aws-sdk/client-sts';\nimport { PutObjectCommand } from '@aws-sdk/client-s3';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { getConfig, S3Config } from '../../utils/config';\nimport { getClient } from '../../utils/client';\nimport { sanitizeKey, uuid } from '../../utils/keys';\n\ntype NextRouteHandler = (\n  req: NextApiRequest,\n  res: NextApiResponse\n) => Promise<void>;\n\ntype Configure = (options: Options) => Handler;\ntype Handler = NextRouteHandler & { configure: Configure };\n\ntype Options = S3Config & {\n  key?: (req: NextApiRequest, filename: string) => string | Promise<string>;\n};\n\nlet makeRouteHandler = (options: Options = {}): Handler => {\n  let route: NextRouteHandler = async function(req, res) {\n    let config = getConfig({\n      accessKeyId: options.accessKeyId,\n      secretAccessKey: options.secretAccessKey,\n      bucket: options.bucket,\n      region: options.region,\n      forcePathStyle: options.forcePathStyle,\n      endpoint: options.endpoint,\n    });\n\n    let missing = missingEnvs(config);\n    if (missing.length > 0) {\n      res\n        .status(500)\n        .json({ error: `Next S3 Upload: Missing ENVs ${missing.join(', ')}` });\n    } else {\n      let uploadType = req.body._nextS3?.strategy;\n      let filename = req.body.filename;\n\n      let key = options.key\n        ? await Promise.resolve(options.key(req, filename))\n        : `next-s3-uploads/${uuid()}/${sanitizeKey(filename)}`;\n      let { bucket, region, endpoint } = config;\n\n      if (uploadType === 'presigned') {\n        let filetype = req.body.filetype;\n        let client = getClient(config);\n        let params = {\n          Bucket: bucket,\n          Key: key,\n          ContentType: filetype,\n          CacheControl: 'max-age=630720000',\n        };\n\n        const url = await getSignedUrl(client, new PutObjectCommand(params), {\n          expiresIn: 60 * 60,\n        });\n\n        res.status(200).json({\n          key,\n          bucket,\n          region,\n          endpoint,\n          url,\n        });\n      } else {\n        let stsConfig: STSClientConfig = {\n          credentials: {\n            accessKeyId: config.accessKeyId,\n            secretAccessKey: config.secretAccessKey,\n          },\n          region,\n        };\n\n        let policy = {\n          Statement: [\n            {\n              Sid: 'Stmt1S3UploadAssets',\n              Effect: 'Allow',\n              Action: ['s3:PutObject'],\n              Resource: [`arn:aws:s3:::${bucket}/${key}`],\n            },\n          ],\n        };\n\n        let sts = new STSClient(stsConfig);\n\n        let command = new GetFederationTokenCommand({\n          Name: 'S3UploadWebToken',\n          Policy: JSON.stringify(policy),\n          DurationSeconds: 60 * 60, // 1 hour\n        });\n\n        let token = await sts.send(command);\n\n        res.status(200).json({\n          token,\n          key,\n          bucket,\n          region,\n        });\n      }\n    }\n  };\n\n  let configure = (options: Options) => makeRouteHandler(options);\n\n  return Object.assign(route, { configure });\n};\n\nlet missingEnvs = (config: Record<string, any>): string[] => {\n  let required = ['accessKeyId', 'secretAccessKey', 'bucket', 'region'];\n\n  return required.filter(key => !config[key] || config.key === '');\n};\n\nlet APIRoute = makeRouteHandler();\n\nexport { APIRoute };\n","import React, { ChangeEvent, ReactElement } from 'react';\nimport { useRef, useState } from 'react';\nimport { forwardRef } from 'react';\nimport {\n  CompleteMultipartUploadCommandOutput,\n  S3Client,\n} from '@aws-sdk/client-s3';\nimport { Upload } from '@aws-sdk/lib-storage';\n\ntype FileInputProps = {\n  onChange: (\n    file: File | undefined,\n    event: ChangeEvent<HTMLInputElement>\n  ) => void;\n  [index: string]: any; // Indexer to spread props\n};\n\nlet FileInput = forwardRef<HTMLInputElement, FileInputProps>(\n  ({ onChange = () => {}, ...restOfProps }, forwardedRef) => {\n    let handleChange = (event: ChangeEvent<HTMLInputElement>): void => {\n      let file = event.target?.files?.[0];\n      onChange(file, event);\n    };\n\n    return (\n      <input\n        onChange={handleChange}\n        {...restOfProps}\n        ref={forwardedRef}\n        type=\"file\"\n      />\n    );\n  }\n);\n\ntype TrackedFile = {\n  file: File;\n  progress: number;\n  uploaded: number;\n  size: number;\n};\n\ntype UseS3UploadOptions = {\n  endpoint?: string;\n};\n\ntype UploadResult = {\n  url: string;\n  bucket: string;\n  key: string;\n};\n\ntype RequestOptions = {\n  body: Record<string, any>;\n  headers: HeadersInit;\n};\n\ntype EndpointOptions = {\n  request: RequestOptions;\n};\n\ntype UploadToS3Options = {\n  endpoint?: EndpointOptions;\n};\n\ntype UploadToS3 = (\n  file: File,\n  options?: UploadToS3Options\n) => Promise<UploadResult>;\n\ntype UseS3UploadTools = {\n  FileInput: (props: any) => ReactElement<HTMLInputElement>;\n  openFileDialog: () => void;\n  uploadToS3: UploadToS3;\n  files: TrackedFile[];\n  resetFiles: () => void;\n};\n\ntype UseS3Upload = (options?: UseS3UploadOptions) => UseS3UploadTools;\n\nexport const useS3Upload: UseS3Upload = (options = {}) => {\n  let ref = useRef<HTMLInputElement>();\n  let [files, setFiles] = useState<TrackedFile[]>([]);\n\n  let openFileDialog = () => {\n    if (ref.current) {\n      ref.current.value = '';\n      ref.current?.click();\n    }\n  };\n\n  let resetFiles = () => {\n    setFiles([]);\n  };\n\n  let endpoint = options.endpoint ?? '/api/s3-upload';\n\n  let uploadToS3: UploadToS3 = async (file, options = {}) => {\n    let filename = file.name;\n\n    let requestExtras = options?.endpoint?.request ?? {\n      headers: {},\n      body: {},\n    };\n\n    let body = {\n      filename,\n      _nextS3: {\n        strategy: 'aws-sdk',\n      },\n      ...requestExtras.body,\n    };\n\n    let headers = {\n      ...requestExtras.headers,\n      'Content-Type': 'application/json',\n    };\n\n    let res = await fetch(endpoint, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(body),\n    });\n\n    let data = await res.json();\n\n    if (data.error) {\n      console.error(data.error);\n      throw data.error;\n    } else {\n      let client = new S3Client({\n        credentials: {\n          accessKeyId: data.token.Credentials.AccessKeyId,\n          secretAccessKey: data.token.Credentials.SecretAccessKey,\n          sessionToken: data.token.Credentials.SessionToken,\n        },\n        region: data.region,\n      });\n\n      let params = {\n        Bucket: data.bucket,\n        Key: data.key,\n        Body: file,\n        CacheControl: 'max-age=630720000, public',\n        ContentType: file.type,\n      };\n\n      // at some point make this configurable\n      // let uploadOptions = {\n      //   partSize: 100 * 1024 * 1024,\n      //   queueSize: 1,\n      // };\n\n      let s3Upload = new Upload({\n        client,\n        params,\n      });\n\n      setFiles(files => [\n        ...files,\n        { file, progress: 0, uploaded: 0, size: file.size },\n      ]);\n\n      s3Upload.on('httpUploadProgress', progress => {\n        let uploaded = progress.loaded ?? 0;\n        let size = progress.total ?? 0;\n\n        if (uploaded) {\n          setFiles(files =>\n            files.map(trackedFile =>\n              trackedFile.file === file\n                ? {\n                    file,\n                    uploaded,\n                    size,\n                    progress: size ? (uploaded / size) * 100 : 0,\n                  }\n                : trackedFile\n            )\n          );\n        }\n      });\n\n      let uploadResult = (await s3Upload.done()) as CompleteMultipartUploadCommandOutput;\n\n      let url =\n        uploadResult.Bucket && uploadResult.Key\n          ? `https://${uploadResult.Bucket}.s3.${data.region}.amazonaws.com/${uploadResult.Key}`\n          : '';\n\n      return {\n        url,\n        bucket: uploadResult.Bucket ?? '',\n        key: uploadResult.Key ?? '',\n      };\n    }\n  };\n\n  return {\n    FileInput: (props: any) => (\n      <FileInput {...props} ref={ref} style={{ display: 'none' }} />\n    ),\n    openFileDialog,\n    uploadToS3,\n    files,\n    resetFiles,\n  };\n};\n","import React, { ChangeEvent, InputHTMLAttributes } from 'react';\nimport { forwardRef } from 'react';\n\ntype FileInputProps = {\n  onChange: (\n    file: File | undefined,\n    event: ChangeEvent<HTMLInputElement>\n  ) => void;\n} & InputHTMLAttributes<HTMLInputElement>;\n\nexport const FileInput = forwardRef<HTMLInputElement, FileInputProps>(\n  ({ onChange = () => {}, ...restOfProps }, forwardedRef) => {\n    let handleChange = (event: ChangeEvent<HTMLInputElement>): void => {\n      let file = event.target?.files?.[0];\n      onChange(file, event);\n    };\n\n    return (\n      <input\n        onChange={handleChange}\n        {...restOfProps}\n        ref={forwardedRef}\n        type=\"file\"\n      />\n    );\n  }\n);\n","import { useUploadFiles } from './use-upload-files';\n\ntype UploadResult = {\n  url: string;\n  bucket: string;\n  key: string;\n};\n\ntype RequestOptions = {\n  url?: string;\n  body?: Record<string, any>;\n  headers?: HeadersInit;\n};\n\ntype UploadToS3Options = {\n  endpoint?: {\n    request: RequestOptions;\n  };\n};\n\ntype Strategy = 'presigned' | 'aws-sdk';\n\nexport type Uploader = (\n  file: File,\n  params: Record<string, any>,\n  eventHandlers: {\n    onProgress: (uploaded: number) => void;\n  }\n) => Promise<UploadResult>;\n\nexport const useUploader = (strategy: Strategy, uploader: Uploader) => {\n  let {\n    addFile,\n    updateFileProgress,\n    FileInput,\n    openFileDialog,\n    files,\n    resetFiles,\n  } = useUploadFiles();\n\n  let uploadToS3 = async (file: File, options: UploadToS3Options = {}) => {\n    let params = await getUploadParams(\n      strategy,\n      file,\n      options.endpoint?.request\n    );\n\n    if (params.error) {\n      console.error(params.error);\n      throw params.error;\n    }\n\n    addFile(file);\n\n    let result = await uploader(file, params, {\n      onProgress: uploaded => updateFileProgress(file, uploaded),\n    });\n\n    return result;\n  };\n\n  return {\n    FileInput,\n    openFileDialog,\n    uploadToS3,\n    files,\n    resetFiles,\n  };\n};\n\nlet getUploadParams = async (\n  strategy: 'presigned' | 'aws-sdk',\n  file: File,\n  requestOptions?: RequestOptions\n) => {\n  let filename = encodeURIComponent(file.name);\n\n  let additionalBody = requestOptions?.body ?? {};\n  let additionalHeaders = requestOptions?.headers ?? {};\n  let apiRouteUrl = requestOptions?.url ?? '/api/s3-upload';\n\n  let body = {\n    filename,\n    filetype: file.type,\n    _nextS3: {\n      strategy,\n    },\n    ...additionalBody,\n  };\n\n  let headers = {\n    ...additionalHeaders,\n    'Content-Type': 'application/json',\n  };\n\n  let res = await fetch(apiRouteUrl, {\n    method: 'POST',\n    headers,\n    body: JSON.stringify(body),\n  });\n\n  return await res.json();\n};\n","import { Uploader, useUploader } from './use-uploader';\n\nlet upload: Uploader = async (file, params, { onProgress }) => {\n  let { url, key, bucket, region, endpoint } = params;\n  let buffer = await file.arrayBuffer();\n\n  await new Promise<void>((resolve, reject) => {\n    let xhr = new XMLHttpRequest();\n\n    xhr.upload.onprogress = (event: ProgressEvent) => {\n      onProgress(event.loaded);\n    };\n\n    xhr.open('PUT', url, true);\n    xhr.setRequestHeader('Content-Type', file.type);\n    xhr.setRequestHeader('Cache-Control', 'max-age=630720000');\n\n    xhr.onreadystatechange = function() {\n      if (xhr.readyState === 4) {\n        if (xhr.status >= 200 || xhr.status < 300) {\n          resolve();\n        } else {\n          reject();\n        }\n      }\n    };\n\n    xhr.send(buffer);\n  });\n\n  let resultUrl = endpoint\n    ? `${endpoint}/${bucket}/${key}`\n    : `https://${bucket}.s3.${region}.amazonaws.com/${key}`;\n\n  return {\n    url: resultUrl,\n    bucket,\n    key,\n  };\n};\n\nexport const usePresignedUpload = () => {\n  let hook = useUploader('presigned', upload);\n  return hook;\n};\n","import { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { GetObjectCommand } from '@aws-sdk/client-s3';\nimport { getConfig, S3Config } from './config';\nimport { getClient } from './client';\n\nexport const generateTemporaryUrl = async (\n  key: string,\n  s3Config?: S3Config\n) => {\n  let config = getConfig(s3Config);\n  let client = getClient(s3Config);\n\n  let command = new GetObjectCommand({\n    Bucket: config.bucket,\n    Key: key,\n  });\n\n  let url = await getSignedUrl(client, command, { expiresIn: 3600 });\n\n  return url;\n};\n","interface ImageData {\n  height: number | undefined;\n  width: number | undefined;\n}\n\nexport const getImageData = (file: File | Blob): Promise<ImageData> => {\n  return new Promise(resolve => {\n    if (file.type.split('/')?.[0] === 'image') {\n      let img = new Image();\n      let objectUrl = URL.createObjectURL(file);\n      img.onload = (event: Event) => {\n        let image = event.target as HTMLImageElement;\n        resolve({ height: image.height, width: image.width });\n        URL.revokeObjectURL(objectUrl);\n      };\n      img.src = objectUrl;\n    } else {\n      resolve({ height: undefined, width: undefined });\n    }\n  });\n};\n","import React from 'react';\nimport { FileInput } from '../components/file-input';\nimport { useRef, useState } from 'react';\n\ntype TrackedFile = {\n  file: File;\n  progress: number;\n  uploaded: number;\n  size: number;\n};\n\nexport const useUploadFiles = () => {\n  let ref = useRef<HTMLInputElement>();\n  let [files, setFiles] = useState<TrackedFile[]>([]);\n\n  let openFileDialog = () => {\n    if (ref.current) {\n      ref.current.value = '';\n      ref.current?.click();\n    }\n  };\n\n  let resetFiles = () => {\n    setFiles([]);\n  };\n\n  let updateFileProgress = (file: File, uploaded: number) => {\n    setFiles(files =>\n      files.map(trackedFile =>\n        trackedFile.file === file\n          ? {\n              file,\n              uploaded,\n              size: file.size,\n              progress: file.size ? (uploaded / file.size) * 100 : 0,\n            }\n          : trackedFile\n      )\n    );\n  };\n\n  let addFile = (file: File) => {\n    setFiles(files => [\n      ...files,\n      { file, progress: 0, uploaded: 0, size: file.size },\n    ]);\n  };\n\n  return {\n    FileInput: (props: any) => (\n      <FileInput {...props} ref={ref} style={{ display: 'none' }} />\n    ),\n    openFileDialog,\n    files,\n    addFile,\n    updateFileProgress,\n    resetFiles,\n  };\n};\n"],"names":["getConfig","s3Config","accessKeyId","process","env","S3_UPLOAD_KEY","secretAccessKey","S3_UPLOAD_SECRET","bucket","S3_UPLOAD_BUCKET","region","S3_UPLOAD_REGION","endpoint","forcePathStyle","getClient","config","S3Client","credentials","uuid","uuidv4","SAFE_CHARACTERS","sanitizeKey","value","replace","makeRouteHandler","options","Object","assign","req","res","missing","missingEnvs","length","_context","status","json","error","join","uploadType","body","_nextS3","_req$body$_nextS","strategy","filename","key","Promise","resolve","filetype","client","params","Bucket","Key","ContentType","CacheControl","getSignedUrl","PutObjectCommand","expiresIn","url","policy","Statement","Sid","Effect","Action","Resource","sts","STSClient","command","GetFederationTokenCommand","Name","Policy","JSON","stringify","DurationSeconds","send","token","configure","filter","APIRoute","FileInput","forwardRef","forwardedRef","onChange","restOfProps","React","event","file","target","_event$target","files","_event$target$files","ref","type","getUploadParams","requestOptions","encodeURIComponent","name","additionalBody","additionalHeaders","headers","apiRouteUrl","Content-Type","_context2","fetch","method","upload","onProgress","arrayBuffer","buffer","reject","xhr","XMLHttpRequest","onprogress","loaded","open","setRequestHeader","onreadystatechange","readyState","generateTemporaryUrl","GetObjectCommand","split","_file$type$split","img","Image","objectUrl","URL","createObjectURL","onload","image","height","width","revokeObjectURL","src","undefined","uploader","addFile","updateFileProgress","resetFiles","setFiles","useRef","useState","props","style","display","openFileDialog","current","_ref$current","click","progress","uploaded","size","map","trackedFile","uploadToS3","_options$endpoint","request","console","requestExtras","_options","_options$endpoint2","data","Credentials","AccessKeyId","SecretAccessKey","sessionToken","SessionToken","s3Upload","Upload","Body","on","total","done","uploadResult"],"mappings":"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"}